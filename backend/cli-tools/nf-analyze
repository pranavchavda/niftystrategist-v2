#!/usr/bin/env python3
"""Technical analysis with RSI, MACD, moving averages, and trading signals."""

import argparse
import sys
import os

_backend_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
if _backend_dir not in sys.path:
    sys.path.insert(0, _backend_dir)

from base import SYMBOLS, format_inr, init_client, print_error, print_json, run_async, validate_symbol  # noqa: E402


def analyze_single(symbol: str, interval: str, as_json: bool):
    """Run full technical analysis on a single stock."""
    from services.technical_analysis import TechnicalAnalysisService

    sym = validate_symbol(symbol)

    client = init_client()
    days_to_fetch = 100 if interval == "day" else 10
    try:
        candles = run_async(client.get_historical_data(sym, interval=interval, days=days_to_fetch))
    except Exception as e:
        print_error(f"Failed to fetch data for {sym}: {e}")

    if not candles:
        print_error(f"No data received for {sym}")
        return


    ta = TechnicalAnalysisService()
    analysis = ta.analyze(sym, candles)
    ind = analysis.indicators

    if as_json:
        print_json({
            "symbol": analysis.symbol,
            "current_price": analysis.current_price,
            "overall_signal": analysis.overall_signal,
            "confidence": analysis.confidence,
            "rsi_14": ind.rsi_14,
            "rsi_signal": analysis.rsi_signal,
            "macd_value": ind.macd_value,
            "macd_signal_line": ind.macd_signal,
            "macd_trend": analysis.macd_trend,
            "price_trend": analysis.price_trend,
            "volume_signal": analysis.volume_signal,
            "sma_20": ind.sma_20,
            "sma_50": ind.sma_50,
            "ema_12": ind.ema_12,
            "ema_26": ind.ema_26,
            "atr_14": ind.atr_14,
            "support_level": analysis.support_level,
            "resistance_level": analysis.resistance_level,
            "reasoning": analysis.reasoning,
        })
        return

    signal_emoji = {
        "strong_buy": "ðŸŸ¢ðŸŸ¢", "buy": "ðŸŸ¢", "hold": "ðŸŸ¡",
        "sell": "ðŸ”´", "strong_sell": "ðŸ”´ðŸ”´",
    }

    emoji = signal_emoji.get(analysis.overall_signal, "")
    print(f"ðŸ“Š Technical Analysis: {analysis.symbol}")
    print(f"   Price: {format_inr(analysis.current_price)}")
    print(f"   Signal: {emoji} {analysis.overall_signal.upper().replace('_', ' ')} (confidence: {analysis.confidence:.0%})")
    print()
    print("   Indicators:")
    rsi_str = f"{ind.rsi_14:.1f}" if ind.rsi_14 is not None else "N/A"
    macd_val_str = f"{ind.macd_value:.2f}" if ind.macd_value is not None else "N/A"
    macd_sig_str = f"{ind.macd_signal:.2f}" if ind.macd_signal is not None else "N/A"
    vol_avg_str = f"{ind.volume_avg_20:,.0f}" if ind.volume_avg_20 is not None else "N/A"

    print(f"     RSI (14):  {rsi_str} â†’ {analysis.rsi_signal.upper()}")
    print(f"     MACD:      {macd_val_str} (signal: {macd_sig_str}) â†’ {analysis.macd_trend.upper()}")
    print(f"     Trend:     {analysis.price_trend.upper()}")
    print(f"     Volume:    {analysis.volume_signal.upper()} ({ind.current_volume:,.0f} vs avg {vol_avg_str})")
    print()
    
    sma20_str = format_inr(ind.sma_20) if ind.sma_20 is not None else "N/A"
    sma50_str = format_inr(ind.sma_50) if ind.sma_50 is not None else "N/A"
    ema12_str = format_inr(ind.ema_12) if ind.ema_12 is not None else "N/A"
    ema26_str = format_inr(ind.ema_26) if ind.ema_26 is not None else "N/A"
    atr14_str = format_inr(ind.atr_14) if ind.atr_14 is not None else "N/A"

    print("   Moving Averages:")
    print(f"     SMA 20: {sma20_str:<12} |  SMA 50: {sma50_str}")
    print(f"     EMA 12: {ema12_str:<12} |  EMA 26: {ema26_str}")
    print()
    print(f"   ATR (14): {atr14_str}")

    if analysis.support_level or analysis.resistance_level:
        print()
        print("   Key Levels:")
        if analysis.support_level:
            print(f"     Support:    {format_inr(analysis.support_level)}")
        if analysis.resistance_level:
            print(f"     Resistance: {format_inr(analysis.resistance_level)}")

    print(f"\n   Analysis: {analysis.reasoning}")


def compare_stocks(symbols: list[str], interval: str, as_json: bool):
    """Compare technical signals across multiple stocks."""
    from services.technical_analysis import TechnicalAnalysisService

    if len(symbols) < 2:
        print_error("Need at least 2 symbols to compare.")
    if len(symbols) > 5:
        print_error("Maximum 5 symbols can be compared at once.")

    client = init_client()
    ta = TechnicalAnalysisService()
    results = []

    from services.instruments_cache import ensure_loaded, symbol_exists
    ensure_loaded()

    for sym in symbols:
        sym = sym.upper()
        if not symbol_exists(sym):
            results.append({"symbol": sym, "error": "Unknown symbol"})
            continue
        try:
            days_to_fetch = 100 if interval == "day" else 10
            candles = run_async(client.get_historical_data(sym, interval=interval, days=days_to_fetch))
            if candles:
                analysis = ta.analyze(sym, candles)
                results.append({
                    "symbol": sym,
                    "price": analysis.current_price,
                    "signal": analysis.overall_signal,
                    "confidence": analysis.confidence,
                    "rsi": analysis.indicators.rsi_14,
                    "trend": analysis.price_trend,
                })
            else:
                results.append({"symbol": sym, "error": "No data received"})
        except Exception as e:
            results.append({"symbol": sym, "error": str(e)})

    if as_json:
        print_json(results)
        return

    signal_emoji = {
        "strong_buy": "ðŸŸ¢ðŸŸ¢", "buy": "ðŸŸ¢", "hold": "ðŸŸ¡",
        "sell": "ðŸ”´", "strong_sell": "ðŸ”´ðŸ”´",
    }

    print(f"ðŸ“Š Stock Comparison\n")
    print(f"{'Symbol':<12} {'Price':>12} {'Signal':<14} {'Confidence':>10} {'RSI':>6} {'Trend':<10}")
    print("-" * 68)
    for r in results:
        if "error" in r:
            print(f"{r['symbol']:<12} {'âŒ ' + r['error']}")
        else:
            emoji = signal_emoji.get(r["signal"], "")
            rsi_val = f"{r['rsi']:>6.1f}" if r["rsi"] is not None else "   N/A"
            print(
                f"{r['symbol']:<12} {format_inr(r['price']):>12} {emoji + ' ' + r['signal'].upper():<14} "
                f"{r['confidence']:>9.0%} {rsi_val} {r['trend']:<10}"
            )


def main():
    parser = argparse.ArgumentParser(
        prog="nf-analyze",
        description="Technical analysis with RSI, MACD, moving averages, signals",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  nf-analyze RELIANCE                          Full analysis (15min candles)
  nf-analyze HDFCBANK --interval day           Daily timeframe analysis
  nf-analyze RELIANCE TCS INFY --compare       Compare signals across stocks
  nf-analyze RELIANCE --json                   JSON output
""",
    )
    parser.add_argument("symbols", nargs="+", help="Stock symbol(s)")
    parser.add_argument("--json", action="store_true", help="Output as JSON")
    parser.add_argument("--compare", action="store_true", help="Compare mode (multiple symbols)")
    parser.add_argument(
        "--interval", default="15minute",
        choices=["15minute", "30minute", "day"],
        help="Analysis timeframe (default: 15minute)",
    )

    args = parser.parse_args()

    if args.compare or len(args.symbols) > 1:
        compare_stocks(args.symbols, args.interval, args.json)
    else:
        analyze_single(args.symbols[0], args.interval, args.json)


if __name__ == "__main__":
    main()
