#!/usr/bin/env python3
"""View portfolio holdings, positions, and P&L."""

import argparse
import sys
import os

_backend_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
if _backend_dir not in sys.path:
    sys.path.insert(0, _backend_dir)

from base import format_change, format_inr, init_client, print_error, print_json, run_async  # noqa: E402


def show_portfolio(as_json: bool):
    """Show full portfolio summary."""
    client = init_client()
    try:
        portfolio = run_async(client.get_portfolio())
    except Exception as e:
        print_error(f"Failed to get portfolio: {e}")

    if as_json:
        data = {
            "total_value": portfolio.total_value,
            "available_cash": portfolio.available_cash,
            "invested_value": portfolio.invested_value,
            "day_pnl": portfolio.day_pnl,
            "day_pnl_percentage": portfolio.day_pnl_percentage,
            "total_pnl": portfolio.total_pnl,
            "total_pnl_percentage": portfolio.total_pnl_percentage,
            "positions": [
                {
                    "symbol": p.symbol,
                    "quantity": p.quantity,
                    "average_price": p.average_price,
                    "current_price": p.current_price,
                    "pnl": p.pnl,
                    "pnl_percentage": p.pnl_percentage,
                    "day_change": p.day_change,
                    "day_change_percentage": p.day_change_percentage,
                }
                for p in portfolio.positions
            ],
        }
        print_json(data)
        return

    # Human-readable
    mode = "Paper" if client.paper_trading else "Live"
    print(f"ðŸ’¼ Portfolio Summary [{mode}]\n")
    print(f"  Total Value:    {format_inr(portfolio.total_value)}")
    print(f"  Available Cash: {format_inr(portfolio.available_cash)}")
    print(f"  Invested:       {format_inr(portfolio.invested_value)}")
    print(f"  Day P&L:        {format_inr(portfolio.day_pnl)} ({portfolio.day_pnl_percentage:+.2f}%)")
    print(f"  Total P&L:      {format_inr(portfolio.total_pnl)} ({portfolio.total_pnl_percentage:+.2f}%)")

    if portfolio.positions:
        print(f"\n{'Symbol':<12} {'Qty':>5} {'Avg Price':>12} {'Current':>12} {'P&L':>12} {'%':>8}")
        print("-" * 65)
        for p in portfolio.positions:
            arrow = "â–²" if p.pnl >= 0 else "â–¼"
            print(
                f"{p.symbol:<12} {p.quantity:>5} {format_inr(p.average_price):>12} "
                f"{format_inr(p.current_price):>12} {arrow} {format_inr(p.pnl):>10} {p.pnl_percentage:>+7.2f}%"
            )
    else:
        print("\n  No open positions.")


def show_position(symbol: str, as_json: bool):
    """Show details for a specific position."""
    client = init_client()
    sym = symbol.upper()
    try:
        portfolio = run_async(client.get_portfolio())
    except Exception as e:
        print_error(f"Failed to get portfolio: {e}")

    position = next((p for p in portfolio.positions if p.symbol.upper() == sym), None)
    if not position:
        print_error(f"No position found for {sym}")

    if as_json:
        print_json({
            "symbol": position.symbol,
            "quantity": position.quantity,
            "average_price": position.average_price,
            "current_price": position.current_price,
            "pnl": position.pnl,
            "pnl_percentage": position.pnl_percentage,
            "day_change": position.day_change,
            "day_change_percentage": position.day_change_percentage,
            "total_value": position.quantity * position.current_price,
        })
        return

    print(f"ðŸ“Š Position: {position.symbol}\n")
    print(f"  Quantity:      {position.quantity} shares")
    print(f"  Avg Price:     {format_inr(position.average_price)}")
    print(f"  Current Price: {format_inr(position.current_price)}")
    print(f"  Total Value:   {format_inr(position.quantity * position.current_price)}")
    print(f"  Total P&L:     {format_inr(position.pnl)} ({position.pnl_percentage:+.2f}%)")
    print(f"  Day Change:    {format_inr(position.day_change)} ({position.day_change_percentage:+.2f}%)")


def calc_position_size(symbol: str, risk_amount: float, stop_loss_pct: float, as_json: bool):
    """Calculate recommended position size."""
    client = init_client()
    sym = symbol.upper()
    try:
        quote = run_async(client.get_quote(sym))
    except Exception as e:
        print_error(f"Failed to get quote for {sym}: {e}")

    price = quote["ltp"]
    risk_per_share = price * (stop_loss_pct / 100)
    qty = int(risk_amount / risk_per_share) if risk_per_share > 0 else 0
    total_investment = qty * price
    stop_loss_price = price * (1 - stop_loss_pct / 100)

    if as_json:
        print_json({
            "symbol": sym,
            "current_price": price,
            "risk_amount": risk_amount,
            "stop_loss_percent": stop_loss_pct,
            "stop_loss_price": round(stop_loss_price, 2),
            "recommended_quantity": qty,
            "total_investment": round(total_investment, 2),
            "max_loss": round(risk_amount, 2),
        })
        return

    if qty < 1:
        print_error(
            f"With {format_inr(risk_amount)} risk and {stop_loss_pct}% SL, "
            f"cannot buy even 1 share of {sym} at {format_inr(price)}."
        )

    print(f"ðŸ“ Position Size: {sym}\n")
    print(f"  Current Price:  {format_inr(price)}")
    print(f"  Risk Amount:    {format_inr(risk_amount)}")
    print(f"  Stop Loss:      {stop_loss_pct}% ({format_inr(stop_loss_price)})")
    print(f"  Recommended Qty: {qty} shares")
    print(f"  Total Investment: {format_inr(total_investment)}")
    print(f"  Max Loss if SL:  {format_inr(risk_amount)}")


def main():
    parser = argparse.ArgumentParser(
        prog="nf-portfolio",
        description="View portfolio, positions, and calculate position sizes",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  nf-portfolio                                  Full portfolio summary
  nf-portfolio --position RELIANCE              Single position details
  nf-portfolio --calc-size RELIANCE --risk 5000 --sl 2  Position size calculator
  nf-portfolio --json                           JSON output
""",
    )
    parser.add_argument("--json", action="store_true", help="Output as JSON")
    parser.add_argument("--position", metavar="SYMBOL", help="Show details for a specific position")
    parser.add_argument("--calc-size", metavar="SYMBOL", help="Calculate position size for a symbol")
    parser.add_argument("--risk", type=float, default=5000, help="Risk amount in rupees (default: 5000)")
    parser.add_argument("--sl", type=float, default=2.0, help="Stop loss percentage (default: 2.0)")

    args = parser.parse_args()

    if args.calc_size:
        calc_position_size(args.calc_size, args.risk, args.sl, args.json)
    elif args.position:
        show_position(args.position, args.json)
    else:
        show_portfolio(args.json)


if __name__ == "__main__":
    main()
